<?php
error_reporting(0);
session_start();
function print_html_head(){
    echo '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"  
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">  
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="zh">  
    <head>  
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  
    <title>WDump</title>  
    <style type="text/css">  
        table caption, table th, table td {  
            padding: 0.1em 0.5em 0.1em 0.5em;  
            margin: 0.1em;  
            vertical-align: top;  
        }  
        th {  
            font-weight: bold;  
            color: black;  
            background: #D3DCE3;  
        }  
        table tr.odd th, .odd {  
            background: #E5E5E5;  
        }  
        table tr.even th, .even {  
            background: #f3f3f3;  
        }  
        .db_table{  
            border-top:1px solid #333;  
        }  
        .title{font-weight:bold;}  
    </style>  
    </head>';
}
function print_databse_info($dbname, $conn)
{
    #echo $dbname;
    $smt = $conn->query("SHOW TABLE STATUS FROM $dbname");
    $array = array();
    $data = $smt->fetchAll(PDO::FETCH_ASSOC);
    foreach ($data as $key => $rows) {
        $array[] = $rows;
    }
    $tab_count = count($array);
    foreach ($array as $k => $v) {
        echo '<ul type="square">' . "\n";
        echo '  <li class="title">';
        echo ($k + 1) . '、表名：[<a href="?action=dumptable&table='.$v['Name'].'&database='.$_GET['database'].'">' . $v['Name'] . '</a>]      注释：' . $v['Comment'];
        echo '</li>' . "\n";

        $tab_name = $v['Name'];
        $tab_smt = $conn->query("show full fields from $dbname.$tab_name");

        $tab_array = array();
        $tab_data = $tab_smt->fetchAll(PDO::FETCH_ASSOC);
        foreach ($tab_data as $tab_k => $tab_v) {
            $tab_array[] = $tab_v;
        }
        $key_smt = $conn->query("show keys from $dbname.$tab_name");
        $key_data = $key_smt->fetchAll(PDO::FETCH_ASSOC);
        $arr_keys = array();
        $arr_keys = $key_data[0];

        echo '<li style="list-style: none outside none;"><table border="0" class="db_table" >';
        echo '<tr class="head">  
            <th style="width:110px">字段</th>  
            <th>类型</th>  
            <th>为空</th>  
            <th>额外</th>  
            <th>默认</th>  
            <th style="width:95px">整理</th>  
            <th>备注</th></tr>';
        foreach ($tab_array as $tk => $tv) {
            $key_name = $arr_keys['Key_name'];
            if ($key_name = "PRIMARY") {
                $key_name = '主键（' . $key_name . '）';
            }
            $key_field = $arr_keys['Column_name'];
            if ($tv['Field'] == $key_field) {
                $key_value = "PK";
            } else {
                $key_value = "";
            }
            echo '        <tr class="' . ($tk % 2 == 0 ? "odd" : "even") . '">' . "\n";
            echo '          <td>' . $tv['Field'] . '</td>' . "\n";
            echo '          <td>' . $tv['Type'] . '</td>' . "\n";
            echo '          <td>' . ($key_value != '' ? $key_value : $tv['Null']) . '</td>' . "\n";
            echo '          <td>' . $tv['Extra'] . '</td>' . "\n";
            echo '          <td>' . $tv['Default'] . '</td>' . "\n";
            echo '          <td>' . $tv['Collation'] . '</td>' . "\n";
            echo '          <td>' . ($key_value != '' ? $key_name : $tv['Comment']) . '</td>' . "\n";
            echo '        </tr>' . "\n";
        }
        echo '  </table></li>' . "\n";
        echo '</ul>' . "\n";
    }
    echo '</div></body>' . "\n";
    echo '</html>' . "\n";
}

function show_database_action($db_array,$conn){
    foreach ($db_array as $k => $v) {
        echo "\n\t\t\t\t".'<a href="?action=showtable&database=' . $v['Database'] . '">'.$v['Database'].'</a>' . "\n";
    }
}

function dump_table($db,$table,$conn){
    ini_set('max_execution_time', 300);
    ini_set('memory_limit', '2048M');
    $filename = $table.'.csv';
    $index = 0;
    $fp = fopen($filename, 'w');
    chmod($filename, 0777);
    $headarr = $conn->query("select group_concat(column_name) from information_schema.columns where table_schema='$db' and table_name='$table';")->fetchAll(PDO::FETCH_ASSOC)[0];
    foreach ($headarr as $k => $head) {
        fputcsv($fp,explode(',',iconv("UTF-8", "GBK", $head)));
    }
    $smt = $conn->query("select * from $db.$table");
    $res = $smt->fetchAll(PDO::FETCH_ASSOC);
    foreach ($res as $key => $val) {
        $data_array=array();
        foreach ($val as $k => $v) {
            $data_array[] = iconv("UTF-8", "GBK", $v)."\t";
            if ($index == 10000) { 
                $index = 0;
                ob_flush();
                flush();
            }
            $index++;
        }
        fputcsv($fp, $data_array);
    }
    ob_flush();
    fclose($fp);
    header("Cache-Control: max-age=0");
    header("Content-type:application/vnd.ms-excel;charset=UTF-8");
    header("Content-Description: File Transfer");
    header('Content-disposition: attachment; filename=' .$table.'.csv');
    header("Content-Type: text/csv");
    header("Content-Transfer-Encoding: binary");
    @readfile($filename);
    unlink($filename);
    return;
}

if (isset($_SESSION['DB_USER']) && isset($_SESSION['DB_PASS']) && isset($_SESSION['DB_HOST'])) {
    header('content-type:text/html;charset=utf-8');
    define('DB_HOST', $_SESSION['DB_HOST']);
    define('DB_USER', $_SESSION['DB_USER']);
    define('DB_PASS', $_SESSION['DB_PASS']);
    define('DB_PORT', 3306);
    define('DB_CHAR', 'utf8');
    define('DBMS', 'mysql');
    $dsn = DBMS . ":host=" . DB_HOST;
    try {
        $conn = new PDO($dsn, DB_USER, DB_PASS, array(PDO::ATTR_PERSISTENT => true));
        $dbh = null;
    } catch (PDOException $e) {
        unset($_SESSION['DB_USER']);
        unset($_SESSION['DB_PASS']);
        unset($_SESSION['DB_HOST']);
        die("Error!: " . $e->getMessage() . "<br/>Refresh and Try Again");
    }
    $conn->exec('set names' . DB_CHAR);
    $smt = $conn->query("show databases;");
    $dbdata = $smt->fetchAll(PDO::FETCH_ASSOC);
    $db_array = array();
    foreach ($dbdata as $dbk => $dbv) {
        $db_array[] = $dbv;
    }
    if (isset($_GET['action'])){
        if($_GET['action'] == 'showtable'){
            if(!empty($_GET['database'])){
                print_html_head();
                echo '<body><div>'."\n";
                show_database_action($db_array,$conn);
                print_databse_info($_GET['database'],$conn);
            }
        }
        elseif($_GET['action'] == 'dumptable'){
            if(!empty($_GET['database'])&&!empty($_GET['table'])){
                dump_table($_GET['database'],$_GET['table'],$conn);
            }
            else{
                echo 'need $_GET[\'table\'] and $_GET[\'database\']';
            }    
        }
        else{
            print_html_head();
            echo '<body><div>'."\n";
            show_database_action($db_array,$conn);
        }
    }
    else{
        print_html_head();
        echo '<body><div>'."\n";
        show_database_action($db_array,$conn);
    }
} else {
    #echo 1;
    if (isset($_POST['DB_USER']) && isset($_POST['DB_HOST']) && isset($_POST['DB_PASS'])) {
        $_SESSION['DB_USER'] = $_POST['DB_USER'];
        $_SESSION['DB_PASS'] = $_POST['DB_PASS'];
        $_SESSION['DB_HOST'] = $_POST['DB_HOST'];
        echo $_POST['DB_USER'];
        echo $_SESSION['DB_USER'];
        header("Location: #");
    } else {
        echo <<<FORM_EOF
        <html>
        <body>
            <head></head>
            <form action='#' method='POST'>
            <table>
                <tr>
                    <th>DATABASE</th>
                </tr>
                <tr>
                    <td>DB_HOST:</td>
                    <td><input type='text' name='DB_HOST'></td>
                </tr>
                <tr>
                    <td>DB_USER:</td>
                    <td><input type='text' name='DB_USER'></td>
                </tr>
                <tr>
                    <td>DB_PASS:</td>
                    <td><input type='text' name='DB_PASS'></td>
                </tr>
                <tr>
                    <td><input type='submit' value='go!'></td>
                </tr>
            </table>
            </form>
        </body>
        </html>
FORM_EOF;
    }
}
